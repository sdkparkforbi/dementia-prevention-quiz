<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì¹˜ë§¤ì˜ˆë°© ë‘ë‡Œ ê²Œì„</title>

<style>
*{margin:0;padding:0;box-sizing:border-box}
body{
 font-family:'Malgun Gothic',sans-serif;
 background:linear-gradient(135deg,#667eea,#764ba2);
 min-height:100vh;padding:20px
}
.container{max-width:900px;margin:0 auto}
h1{text-align:center;color:white;margin-bottom:30px}

.panel{background:white;padding:20px;border-radius:15px;margin-bottom:20px}
input{
 width:100%;padding:15px;font-size:1.2em;
 border-radius:10px;border:2px solid #667eea
}
button{
 width:100%;padding:16px;border:none;border-radius:12px;
 background:#667eea;color:white;font-size:1.2em;cursor:pointer
}

.cards,.quiz-cards{
 display:flex;gap:12px;justify-content:center;margin-top:15px
}
.hwatu-img{
 width:70px;aspect-ratio:3/5;object-fit:contain;
 border-radius:8px;box-shadow:0 4px 10px rgba(0,0,0,.2)
}
.card-back{
 width:70px;aspect-ratio:3/5;
 background:#333;color:white;
 display:flex;align-items:center;justify-content:center;
 border-radius:8px;font-size:1.2em;font-weight:bold
}

.quiz-card{
 background:white;padding:20px;border-radius:15px;margin-bottom:15px
}
.option{
 padding:12px;border:2px solid #ddd;border-radius:10px;
 margin-top:8px;cursor:pointer
}
.option.selected{background:#667eea;color:white}
</style>
</head>

<body>
<div class="container">
<h1>ğŸ§  ì¹˜ë§¤ì˜ˆë°© ë‘ë‡Œ ê²Œì„</h1>

<div class="panel">
<label>ğŸ‘¤ ì´ë¦„</label>
<input id="userName" placeholder="í™ê¸¸ë™">
</div>

<div class="panel">
<button onclick="startGame()">ğŸ´ í™”íˆ¬ 3ì¥ ë½‘ê¸°</button>
<div class="cards" id="cardArea"></div>
<p id="hint" style="text-align:center;margin-top:10px;"></p>
</div>

<div id="quizArea"></div>

<button onclick="submitResult()">ê²°ê³¼ ì €ì¥í•˜ê¸°</button>
</div>

<script>
const deck=[
 {m:1,n:"ì†Œë‚˜ë¬´",s:"ê²¨ìš¸",i:"/hwatu/01_pine.png"},
 {m:2,n:"ë§¤í™”",s:"ê²¨ìš¸",i:"/hwatu/02_plum.png"},
 {m:3,n:"ë²šê½ƒ",s:"ë´„",i:"/hwatu/03_cherry.png"},
 {m:4,n:"ë“±ë‚˜ë¬´",s:"ë´„",i:"/hwatu/04_wisteria.png"},
 {m:5,n:"ì°½í¬",s:"ë´„",i:"/hwatu/05_iris.png"},
 {m:6,n:"ëª¨ë€",s:"ì—¬ë¦„",i:"/hwatu/06_peony.png"},
 {m:7,n:"ì‹¸ë¦¬",s:"ì—¬ë¦„",i:"/hwatu/07_bushclover.png"},
 {m:8,n:"ê³µì‚°",s:"ì—¬ë¦„",i:"/hwatu/08_grass.png"},
 {m:9,n:"êµ­í™”",s:"ê°€ì„",i:"/hwatu/09_chrysanthemum.png"},
 {m:10,n:"ë‹¨í’",s:"ê°€ì„",i:"/hwatu/10_maple.png"},
 {m:11,n:"ì˜¤ë™",s:"ê°€ì„",i:"/hwatu/11_paulownia.png"},
 {m:12,n:"ë¹„/í•™",s:"ê²¨ìš¸",i:"/hwatu/12_rain.png"}
];

let cards=[],answers={};
const shuffle=a=>a.sort(()=>Math.random()-0.5);

function startGame(){
 cards=shuffle([...deck]).slice(0,3);
 document.getElementById("cardArea").innerHTML=
  cards.map(c=>`<img src="${c.i}" class="hwatu-img">`).join("");
 document.getElementById("hint").innerText="ì¹´ë“œë¥¼ 3ì´ˆ ë™ì•ˆ ê¸°ì–µí•´ì£¼ì„¸ìš”.";
 setTimeout(hideCards,3000);
}

function hideCards(){
 document.getElementById("cardArea").innerHTML=
  cards.map(()=>`<div class="card-back">?</div>`).join("");
 renderQuiz();
}

function renderQuiz(){
 const sum=cards.reduce((a,c)=>a+c.m,0);
 const season=most(cards.map(c=>c.s));

 document.getElementById("quizArea").innerHTML=`
 <div class="quiz-card">
  <b>ê¸°ì–µ í›ˆë ¨</b>
  ${shuffle(cards.map(c=>c.n))
    .map(n=>`<div class="option" onclick="sel('mem','${n}',this)">${n}</div>`).join("")}
 </div>

 <div class="quiz-card">
  <b>ê³„ì‚° í›ˆë ¨</b>
  <div class="quiz-cards">
    ${cards.map(c=>`<img src="${c.i}" class="hwatu-img">`).join("")}
  </div>
  ${shuffle([sum,sum+1,sum-1,sum+2])
    .map(n=>`<div class="option" onclick="sel('calc',${n},this)">${n}</div>`).join("")}
 </div>

 <div class="quiz-card">
  <b>ë¶„ë¥˜ í›ˆë ¨</b>
  <div class="quiz-cards">
    ${cards.map(c=>`<img src="${c.i}" class="hwatu-img">`).join("")}
  </div>
  ${["ë´„","ì—¬ë¦„","ê°€ì„","ê²¨ìš¸"]
    .map(s=>`<div class="option" onclick="sel('class','${s}',this)">${s}</div>`).join("")}
 </div>`;
}

function sel(k,v,el){
 answers[k]=v;
 el.parentNode.querySelectorAll('.option').forEach(o=>o.classList.remove('selected'));
 el.classList.add('selected');
}

function most(a){
 return a.sort((x,y)=>a.filter(v=>v===x).length-a.filter(v=>v===y).length).pop();
}

async function submitResult(){
 const name=document.getElementById("userName").value || "ì´ë¦„ì—†ìŒ";
 const sum=cards.reduce((a,c)=>a+c.m,0);
 const season=most(cards.map(c=>c.s));

 const content=`
[${new Date().toLocaleDateString()} í™”íˆ¬ ì¸ì§€í›ˆë ¨ ê²°ê³¼]

ì´ë¦„: ${name}

í™”íˆ¬íŒ¨:
${cards.map(c=>`- ${c.m}ì›” ${c.n} (${c.s})`).join("\n")}

ê²°ê³¼:
- ê¸°ì–µ í›ˆë ¨: ${answers.mem===cards[0].n?"ì •í™•":"ì˜¤ë‹µ"}
- ê³„ì‚° í›ˆë ¨: ${answers.calc==sum?"ì •í™•":"ì˜¤ë‹µ"}
- ë¶„ë¥˜ í›ˆë ¨: ${answers.class===season?"ì •í™•":"ì˜¤ë‹µ"}

ì¢…í•©:
í™”íˆ¬ ì´ë¯¸ì§€ ê¸°ë°˜ ì¸ì§€ ìê·¹ í™œë™ì„ ìˆ˜í–‰í•¨.
`;

 const res = await fetch("/.netlify/functions/save-knowledge",{
  method:"POST",
  headers:{ "Content-Type":"application/json" },
  body:JSON.stringify({ content })
 });

 if(res.ok){
   triggerAvatarGreeting();
   alert("ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.\nì•„ë°”íƒ€ê°€ ê²°ê³¼ë¥¼ ì„¤ëª…í•©ë‹ˆë‹¤.");
 }else{
   alert("ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.");
 }
}

/* âœ… ê²°ê³¼ ì €ì¥ í›„ ì•„ë°”íƒ€ ìë™ ë°œí™” íŠ¸ë¦¬ê±° */
function triggerAvatarGreeting(){
  window.postMessage(
    {
      type: "DID_AGENT_EVENT",
      event: "start-conversation",
      payload: {
        text: "ë°©ê¸ˆ ì €ì¥ëœ ì˜¤ëŠ˜ ì¸ì§€í›ˆë ¨ ê²°ê³¼ë¥¼ ê°„ë‹¨íˆ ìš”ì•½í•´ì„œ ì–´ë¥´ì‹ ê»˜ ì„¤ëª…í•´ ì£¼ì„¸ìš”."
      }
    },
    "*"
  );
}
</script>

<!-- âœ… D-ID AI ì•„ë°”íƒ€ (í•„ìˆ˜) -->
<script type="module"
  src="https://agent.d-id.com/v2/index.js"
  data-mode="fabio"
  data-client-key="Z29vZ2xlLW9hdXRoMnwxMTI3NjQ3MzA0NTM3NjA0MTgyMTI6d01EN0x6bFFFMmlZSk9nUHNacXll"
  data-agent-id="v2_agt_adow2aMU"
  data-name="did-agent"
  data-monitor="true"
  data-orientation="horizontal"
  data-position="right">
</script>

</body>
</html>
