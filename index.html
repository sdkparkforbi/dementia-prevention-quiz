<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ì˜¤ëŠ˜ì˜ ë‘ë‡Œ í™œë™</title>
  <style>
    * { margin:0; padding:0; box-sizing:border-box; }
    body{
      font-family:'Malgun Gothic', sans-serif;
      background:linear-gradient(135deg,#667eea 0%, #764ba2 100%);
      min-height:100vh;
      padding:20px;
    }
    .container{ max-width:900px; margin:0 auto; }
    h1{
      text-align:center;
      color:white;
      font-size:2.4em;
      margin:10px 0 22px;
      text-shadow:2px 2px 4px rgba(0,0,0,0.25);
      letter-spacing:0.5px;
    }

    .card{
      background:white;
      padding:24px;
      border-radius:18px;
      margin-bottom:18px;
      box-shadow:0 10px 30px rgba(0,0,0,0.18);
    }
    .title{ font-size:1.5em; margin-bottom:10px; color:#222; }
    .desc{ color:#444; line-height:1.8; font-size:1.05em; }

    .input{
      margin-top:12px;
      width:100%;
      padding:14px;
      font-size:1.1em;
      border:2px solid #d4d7dd;
      border-radius:12px;
      outline:none;
    }
    .input:focus{ border-color:#667eea; }

    .btn{
      width:100%;
      padding:16px;
      border:none;
      border-radius:12px;
      background:linear-gradient(135deg,#667eea,#764ba2);
      color:white;
      font-size:1.2em;
      cursor:pointer;
      margin-top:14px;
      transition:transform 0.15s ease;
    }
    .btn:hover{ transform:scale(1.01); }
    .btn.secondary{
      background:#eef1f6;
      color:#333;
      border:2px solid #d4d7dd;
    }
    .btn:disabled{
      background:#c9c9c9;
      cursor:not-allowed;
      transform:none;
    }

    .grid{
      display:grid;
      grid-template-columns:repeat(4, 1fr);
      gap:18px;
      justify-items:center;
      margin-top:14px;
    }

    /* Flip card */
    .flip-card{
      width:122px;
      height:188px;
      perspective:1000px;
      cursor:pointer;
      user-select:none;
    }
    .flip-inner{
      width:100%;
      height:100%;
      position:relative;
      transform-style:preserve-3d;
      transition:transform 0.55s ease;
    }
    .flip-card.flipped .flip-inner{ transform:rotateY(180deg); }
    .face{
      position:absolute;
      width:100%;
      height:100%;
      backface-visibility:hidden;
      border-radius:14px;
      overflow:hidden;
      box-shadow:0 6px 18px rgba(0,0,0,0.12);
    }
    .face img{ width:100%; height:100%; object-fit:cover; display:block; }
    .front{ transform:rotateY(180deg); }

    .picked-outline{ outline:4px solid #667eea; border-radius:16px; }
    .muted{ opacity:0.55; }

    .img-row{
      display:flex;
      gap:16px;
      justify-content:center;
      align-items:center;
      margin-top:14px;
      flex-wrap:wrap;
    }
    .img-row img{
      width:122px;
      height:188px;
      border-radius:14px;
      box-shadow:0 6px 18px rgba(0,0,0,0.12);
      object-fit:cover;
    }

    /* Options */
    .q-title{ font-size:1.18em; color:#222; margin-bottom:10px; line-height:1.6; }
    .options{ display:flex; flex-direction:column; gap:10px; margin-top:10px; }
    .option{
      padding:14px 14px;
      border-radius:12px;
      border:2px solid #e1e4ea;
      background:#fafbfc;
      cursor:pointer;
      transition:all 0.15s ease;
      font-size:1.08em;
      color:#222;
      user-select:none;
    }
    .option:hover{ border-color:#667eea; background:#eef4ff; }
    .option.selected{
      background:#667eea;
      color:white;
      border-color:#667eea;
    }
    .option.correct{
      background:#28a745;
      border-color:#28a745;
      color:white;
    }
    .option.wrong{
      background:#dc3545;
      border-color:#dc3545;
      color:white;
    }

    .pill{
      display:inline-block;
      padding:6px 12px;
      background:#eef4ff;
      border:1px solid #d6e4ff;
      color:#2457d6;
      border-radius:999px;
      font-weight:700;
      font-size:0.95em;
      margin-bottom:10px;
    }

    .status{
      margin-top:14px;
      padding:12px;
      border-radius:12px;
      display:none;
      font-size:1.05em;
      line-height:1.6;
    }
    .status.show{ display:block; }
    .status.success{ background:#d4edda; color:#155724; border:2px solid #28a745; }
    .status.error{ background:#f8d7da; color:#721c24; border:2px solid #dc3545; }

    @media (max-width: 600px){
      .grid{ grid-template-columns:repeat(3, 1fr); gap:14px; }
      .flip-card{ width:104px; height:160px; }
      .img-row img{ width:104px; height:160px; }
      h1{ font-size:2.0em; }
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>ğŸ§  ì˜¤ëŠ˜ì˜ ë‘ë‡Œ í™œë™</h1>
    <div id="app"></div>
  </div>

  <!-- D-ID ì•„ë°”íƒ€ (ì‚¬ìš©ì ì œê³µ ê°’ ë°˜ì˜) -->
  <script type="module"
    src="https://agent.d-id.com/v2/index.js"
    data-mode="fabio"
    data-client-key="Z29vZ2xlLW9hdXRoMnwxMTI3NjQ3MzA0NTM3NjA0MTgyMTI6d01EN0x6bFFFMmlZSk9nUHNacXll"
    data-agent-id="v2_agt_adow2aMU"
    data-name="did-agent"
    data-monitor="true"
    data-orientation="horizontal"
    data-position="right">
  </script>

  <script>
    /* =========================
      ì„¤ì •: ì´ë¯¸ì§€ ê²½ë¡œ
    ========================= */
    const IMG_BASE = "/hwatu";
    const BACK_IMG = `${IMG_BASE}/back.png`;

    const deck = [
      { id: 1, key:"01_pine", img: `${IMG_BASE}/01_pine.png`, label:"ì†Œë‚˜ë¬´" },
      { id: 2, key:"02_plum", img: `${IMG_BASE}/02_plum.png`, label:"ë§¤í™”" },
      { id: 3, key:"03_cherry", img: `${IMG_BASE}/03_cherry.png`, label:"ë²šê½ƒ" },
      { id: 4, key:"04_wisteria", img: `${IMG_BASE}/04_wisteria.png`, label:"ë“±ë‚˜ë¬´" },
      { id: 5, key:"05_iris", img: `${IMG_BASE}/05_iris.png`, label:"ì°½í¬" },
      { id: 6, key:"06_peony", img: `${IMG_BASE}/06_peony.png`, label:"ëª¨ë€" },
      { id: 7, key:"07_bushclover", img: `${IMG_BASE}/07_bushclover.png`, label:"ì‹¸ë¦¬" },
      { id: 8, key:"08_grass", img: `${IMG_BASE}/08_grass.png`, label:"ì–µìƒˆ" },
      { id: 9, key:"09_chrysanthemum", img: `${IMG_BASE}/09_chrysanthemum.png`, label:"êµ­í™”" },
      { id:10, key:"10_maple", img: `${IMG_BASE}/10_maple.png`, label:"ë‹¨í’" },
      { id:11, key:"11_paulownia", img: `${IMG_BASE}/11_paulownia.png`, label:"ì˜¤ë™" },
      { id:12, key:"12_rain", img: `${IMG_BASE}/12_rain.png`, label:"ë¹„(ìš°ì‚°)" },
    ];

    /* =========================
      ë‚±ë§ í€´ì¦ˆ (5ë¬¸í•­)
      - ì–´ë¥´ì‹ ì´ â€œëª¨ë¥¼ë§Œí•œ ë‹¨ì–´â€ + ì‰¬ìš´ ì„¤ëª…
    ========================= */
    const wordQuizData = [
      {
        question: "â€˜ì‹œë‚˜ë¸Œë¡œâ€™ëŠ” ì–´ë–¤ ëœ»ì¼ê¹Œìš”?",
        options: ["ëª¨ë¥´ëŠ” ì‚¬ì´ì— ì¡°ê¸ˆì”©", "ê°‘ìê¸° í•œ ë²ˆì—", "í° ì†Œë¦¬ë¡œ", "ê±°ê¾¸ë¡œ"],
        correct: 0,
        explanation: "â€˜ì‹œë‚˜ë¸Œë¡œâ€™ëŠ” â€˜ëª¨ë¥´ëŠ” ì‚¬ì´ì— ì¡°ê¸ˆì”©â€™ì´ë¼ëŠ” ëœ»ì´ì—ìš”."
      },
      {
        question: "â€˜ê¸°ë³„â€™ì€ ì–´ë–¤ ëœ»ì¼ê¹Œìš”?",
        options: ["ì†Œì‹", "ì•½ì†", "ì •ë¦¬", "ë¹„ë°€"],
        correct: 0,
        explanation: "â€˜ê¸°ë³„â€™ì€ â€˜ì†Œì‹â€™ì´ë¼ëŠ” ëœ»ì´ì—ìš”. (ì˜ˆ: ê¸°ë³„ì´ ì—†ë‹¤ = ì†Œì‹ì´ ì—†ë‹¤)"
      },
      {
        question: "â€˜ì–´ìˆ˜ì„ í•˜ë‹¤â€™ëŠ” ì–´ë–¤ ìƒíƒœì¼ê¹Œìš”?",
        options: ["ì •ëˆë˜ì–´ ìˆë‹¤", "ì–´ì§€ëŸ½ê³  ì •ë¦¬ê°€ ì•ˆ ë˜ì–´ ìˆë‹¤", "ì¡°ìš©í•˜ê³  ì°¨ë¶„í•˜ë‹¤", "ë‹¨ë‹¨í•˜ê³  íŠ¼íŠ¼í•˜ë‹¤"],
        correct: 1,
        explanation: "â€˜ì–´ìˆ˜ì„ í•˜ë‹¤â€™ëŠ” â€˜ì–´ì§€ëŸ½ê³  ì •ë¦¬ê°€ ì•ˆ ëœ ìƒíƒœâ€™ë¥¼ ë§í•´ìš”."
      },
      {
        question: "â€˜ë¿Œë“¯í•˜ë‹¤â€™ëŠ” ì–´ë–¤ ë§ˆìŒì¼ê¹Œìš”?",
        options: ["ë¶ˆì•ˆí•˜ê³  ê±±ì •ëœë‹¤", "ì†ìƒí•˜ê³  ìŠ¬í”„ë‹¤", "í•´ë‚´ì„œ ë§ˆìŒì´ ë“ ë“ í•˜ê³  ë§Œì¡±ìŠ¤ëŸ½ë‹¤", "ë¬´ì„­ê³  ë–¨ë¦°ë‹¤"],
        correct: 2,
        explanation: "â€˜ë¿Œë“¯í•˜ë‹¤â€™ëŠ” â€˜í•´ë‚´ì„œ ë§ˆìŒì´ ë“ ë“ í•˜ê³  ë§Œì¡±ìŠ¤ëŸ¬ìš´ ìƒíƒœâ€™ì˜ˆìš”."
      },
      {
        question: "â€˜ì€ê·¼íˆâ€™ëŠ” ì–´ë–¤ ëŠë‚Œì¼ê¹Œìš”?",
        options: ["ì¡°ìš©íˆ ìŠ¬ë©°ì‹œ", "ë§¤ìš° í¬ê²Œ", "ê°‘ìê¸° í™•", "ëŒ€ì¶© ë¹¨ë¦¬"],
        correct: 0,
        explanation: "â€˜ì€ê·¼íˆâ€™ëŠ” â€˜ì¡°ìš©íˆ ìŠ¬ë©°ì‹œ, ëˆˆì— ë„ì§€ ì•Šê²Œâ€™ë¼ëŠ” ëœ»ì´ì—ìš”."
      },
    ];

    /* =========================
      ì¹˜ë§¤ ì˜ˆë°© í€´ì¦ˆ (5ë¬¸í•­ + í•´ì„¤)
    ========================= */
    const dementiaQuizData = [
      {
        question: "ë‹¤ìŒ ì¤‘ ì¹˜ë§¤ ì˜ˆë°©ì— ê°€ì¥ íš¨ê³¼ì ì¸ í™œë™ì€ ë¬´ì—‡ì¼ê¹Œìš”?",
        options: ["í•˜ë£¨ ì¢…ì¼ TV ì‹œì²­í•˜ê¸°", "ê·œì¹™ì ì¸ ìš´ë™ê³¼ ë‘ë‡Œ í™œë™", "í˜¼ìì„œ ì§‘ì—ë§Œ ìˆê¸°", "ê°™ì€ ìŒì‹ë§Œ ë¨¹ê¸°"],
        correct: 1,
        explanation: "ê·œì¹™ì ì¸ ìš´ë™ì€ ë‡Œ í˜ˆë¥˜ë¥¼ ëŠ˜ë¦¬ê³ , ë‘ë‡Œ í™œë™ì€ ì‹ ê²½ ì—°ê²°ì„ ë„ì™€ ì¹˜ë§¤ ì˜ˆë°©ì— ì¢‹ì•„ìš”."
      },
      {
        question: "ê¸°ì–µë ¥ í–¥ìƒì— ë„ì›€ì´ ë˜ëŠ” ì‹í’ˆì´ â€˜ì•„ë‹Œ ê²ƒâ€™ì€?",
        options: ["ë“±í‘¸ë¥¸ ìƒì„ (ê³ ë“±ì–´Â·ì—°ì–´)", "í˜¸ë‘Â·ì•„ëª¬ë“œ ë“± ê²¬ê³¼ë¥˜", "ì‹œê¸ˆì¹˜Â·ë¸Œë¡œì½œë¦¬ ë“± ë…¹ìƒ‰ ì±„ì†Œ", "ê°€ê³µì‹í’ˆê³¼ íŒ¨ìŠ¤íŠ¸í‘¸ë“œ"],
        correct: 3,
        explanation: "ê°€ê³µì‹í’ˆÂ·íŒ¨ìŠ¤íŠ¸í‘¸ë“œëŠ” ì—¼ë¶„Â·ë‹¹ë¶„ì´ ë§ì•„ ë‡Œ ê±´ê°•ì— ì¢‹ì§€ ì•Šì„ ìˆ˜ ìˆì–´ìš”."
      },
      {
        question: "ì¹˜ë§¤ ì´ˆê¸° ì¦ìƒìœ¼ë¡œ ë” í”í•œ ê²ƒì€?",
        options: ["ìµœê·¼ ì¼ì„ ìì£¼ ìŠì–´ë²„ë¦°ë‹¤", "ì˜›ë‚  ì¼ì„ ê¸°ì–µí•˜ì§€ ëª»í•œë‹¤", "ëª¨ë“  ê²ƒì„ ì™„ë²½í•˜ê²Œ ê¸°ì–µí•œë‹¤", "ì ì„ ë§ì´ ìë©´ ë°”ë¡œ ì¹˜ë§¤ë‹¤"],
        correct: 0,
        explanation: "ì¹˜ë§¤ ì´ˆê¸°ì—ëŠ” â€˜ìµœê·¼ ê¸°ì–µ(ë‹¨ê¸° ê¸°ì–µ)â€™ì´ ë¨¼ì € í”ë“¤ë¦¬ëŠ” ê²½ìš°ê°€ ë§ì•„ìš”."
      },
      {
        question: "ë‘ë‡Œ ê±´ê°•ì„ ìœ„í•œ ìˆ˜ë©´ ì‹œê°„ìœ¼ë¡œ ì ë‹¹í•œ ê²ƒì€?",
        options: ["3~4ì‹œê°„", "5~6ì‹œê°„", "7~8ì‹œê°„", "10ì‹œê°„ ì´ìƒë§Œ ìì•¼ í•œë‹¤"],
        correct: 2,
        explanation: "ìˆ˜ë©´ì€ ê¸°ì–µ ì •ë¦¬ì™€ ë‡Œ íšŒë³µì— ì¤‘ìš”í•´ìš”. ë³´í†µ 7~8ì‹œê°„ì´ ê¶Œì¥ë¼ìš”."
      },
      {
        question: "ì‚¬íšŒì  í™œë™ì´ ì¹˜ë§¤ ì˜ˆë°©ì— ë„ì›€ì´ ë˜ëŠ” ì´ìœ ë¡œ ë” ë§ëŠ” ê²ƒì€?",
        options: ["ë‡Œë¥¼ ë‹¤ì–‘í•˜ê²Œ ìê·¹í•˜ê¸° ë•Œë¬¸ì—", "ëˆì„ ë²Œ ìˆ˜ ìˆì–´ì„œ", "ë¬´ì¡°ê±´ ìš´ë™ëŸ‰ì´ ëŠ˜ì–´ì„œ", "ì‹ì‚¬ë¥¼ ë§ì´ í•´ì„œ"],
        correct: 0,
        explanation: "ëŒ€í™”Â·ê°ì • êµë¥˜Â·ë¬¸ì œ í•´ê²° ë“± ë‹¤ì–‘í•œ ë‡Œ ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ê²Œ ë˜ì–´ ì¸ì§€ ê¸°ëŠ¥ ìœ ì§€ì— ë„ì›€ì´ ë¼ìš”."
      }
    ];

    /* =========================
      ìƒíƒœ/ì„¸ì…˜
    ========================= */
    const app = document.getElementById("app");

    const state = {
      userName: "",
      sessionId: "",
      startISO: "",
      endISO: "",

      hwatu: {
        deckOrder: [],
        picked: [],
        memoryShownMs: 5000,
        memoryStartAt: 0,
        recallStartAt: 0,
        recallPicked: [],
        recallCorrect: 0
      },

      word: {
        answers: Array(wordQuizData.length).fill(null),
        results: [],
        score: 0
      },

      dementia: {
        answers: Array(dementiaQuizData.length).fill(null),
        results: [],
        score: 0
      }
    };

    function nowISO(){ return new Date().toISOString(); }
    function newSessionId(){
      // YYYYMMDD_HHMMSS
      const d = new Date();
      const pad = n => String(n).padStart(2,"0");
      return `${d.getFullYear()}${pad(d.getMonth()+1)}${pad(d.getDate())}_${pad(d.getHours())}${pad(d.getMinutes())}${pad(d.getSeconds())}`;
    }
    function shuffle(arr){
      const a = [...arr];
      for(let i=a.length-1;i>0;i--){
        const j = Math.floor(Math.random()*(i+1));
        [a[i], a[j]] = [a[j], a[i]];
      }
      return a;
    }
    function escapeHtml(s){
      return String(s)
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    /* =========================
      í™”ë©´ ë Œë”
    ========================= */
    function renderIntro(){
      app.innerHTML = `
        <div class="card">
          <div class="title">ì˜¤ëŠ˜ì˜ ë‘ë‡Œ í™œë™ì— ì˜¤ì…¨ì–´ìš”</div>
          <div class="desc">
            ì´ ì‹œê°„ì€ ë¨¸ë¦¬ë¥¼ <b>ì‹œí—˜</b>í•˜ëŠ” ì‹œê°„ì´ ì•„ë‹™ë‹ˆë‹¤.<br>
            ì¹´ë“œì™€ ë‹¨ì–´ë¥¼ ë³´ë©° ë¨¸ë¦¬ë¥¼ <b>ì‚´ì§ ê¹¨ì›Œë³´ëŠ” ì‹œê°„</b>ì´ì—ìš”.<br><br>
            ì˜í•˜ê³  ëª»í•˜ê³ ëŠ” ì „í˜€ ì¤‘ìš”í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.<br>
            ì²œì²œíˆ, í¸í•œ ë§ˆìŒìœ¼ë¡œ í•´ë³´ì‹œë©´ ë©ë‹ˆë‹¤.
          </div>

          <input class="input" id="nameInput" placeholder="ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”" />
          <button class="btn" id="startBtn">ì‹œì‘í•˜ê¸°</button>
        </div>
      `;

      document.getElementById("startBtn").onclick = () => {
        const name = document.getElementById("nameInput").value.trim();
        if(!name){ alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”."); return; }
        state.userName = name;
        state.sessionId = newSessionId();
        state.startISO = nowISO();

        // reset module states
        state.hwatu.picked = [];
        state.hwatu.recallPicked = [];
        state.hwatu.recallCorrect = 0;
        state.word.answers = Array(wordQuizData.length).fill(null);
        state.word.results = [];
        state.word.score = 0;
        state.dementia.answers = Array(dementiaQuizData.length).fill(null);
        state.dementia.results = [];
        state.dementia.score = 0;

        renderHwatuPick();
      };
    }

    /* =========================
      1) í™”íˆ¬: 12ì¥ ë’·ë©´ â†’ 3ì¥ ì„ íƒ(ì¤‘ë³µ ë°©ì§€) + ë’¤ì§‘ê¸°
    ========================= */
    function renderHwatuPick(){
      const shuffledDeck = shuffle(deck);
      state.hwatu.deckOrder = shuffledDeck.map(x=>x.key);

      app.innerHTML = `
        <div class="card">
          <div class="title">ì˜¤ëŠ˜ì˜ í™”íˆ¬ ìš´ì„¸ & ê¸°ì–µ í›ˆë ¨</div>
          <div class="desc">
            ë§ˆìŒì— ë“œëŠ” ì¹´ë“œ <b>ì„¸ ì¥</b>ì„ ê³¨ë¼ì£¼ì„¸ìš”.<br>
            ê³ ë¥´ëŠ” ë™ì•ˆ ìì—°ìŠ¤ëŸ½ê²Œ ë¨¸ë¦¬ë¥¼ ì“°ê²Œ ë©ë‹ˆë‹¤.
          </div>

          <div class="grid" id="hwatuGrid">
            ${shuffledDeck.map((c, idx) => `
              <div class="flip-card" data-idx="${idx}">
                <div class="flip-inner">
                  <div class="face back">
                    <img src="${BACK_IMG}" alt="back">
                  </div>
                  <div class="face front">
                    <img src="${c.img}" alt="${escapeHtml(c.label)}">
                  </div>
                </div>
              </div>
            `).join("")}
          </div>

          <div class="desc" style="margin-top:10px; color:#666;">
            ì„ íƒ: <b><span id="pickedCount">0</span>/3</b>
          </div>
        </div>
      `;

      const grid = document.getElementById("hwatuGrid");
      const pickedCount = document.getElementById("pickedCount");

      grid.querySelectorAll(".flip-card").forEach(cardEl=>{
        cardEl.onclick = () => {
          const idx = Number(cardEl.dataset.idx);
          const card = shuffledDeck[idx];

          // ì¤‘ë³µ ë°©ì§€
          if(state.hwatu.picked.some(x=>x.id===card.id)) return;
          if(state.hwatu.picked.length >= 3) return;

          state.hwatu.picked.push(card);
          cardEl.classList.add("flipped","picked-outline");
          pickedCount.textContent = String(state.hwatu.picked.length);

          if(state.hwatu.picked.length === 3){
            // í´ë¦­ ì ê¸ˆ
            grid.querySelectorAll(".flip-card").forEach(el=>el.style.pointerEvents="none");
            setTimeout(renderHwatuMemory, 700);
          }
        };
      });
    }

    /* =========================
      2) í™”íˆ¬: ê¸°ì–µ(5ì´ˆ)
    ========================= */
    function renderHwatuMemory(){
      state.hwatu.memoryStartAt = performance.now();

      app.innerHTML = `
        <div class="card">
          <div class="title">ì¹´ë“œë¥¼ í•œ ë²ˆ ì‚´í´ë³¼ê²Œìš”</div>
          <div class="desc">
            ë°©ê¸ˆ ê³ ë¥¸ ì¹´ë“œ ì„¸ ì¥ì…ë‹ˆë‹¤.<br>
            ì ì‹œ ëˆˆìœ¼ë¡œë§Œ ì²œì²œíˆ ë´ì£¼ì„¸ìš”.<br><br>
            ì¡°ê¸ˆ ìˆë‹¤ê°€ ì´ ì¹´ë“œë“¤ì„ <b>ë‹¤ì‹œ ê³¨ë¼ë³´ëŠ” ì‹œê°„</b>ì´ ìˆì–´ìš”.
          </div>

          <div class="img-row">
            ${state.hwatu.picked.map(c=>`
              <img src="${c.img}" alt="${escapeHtml(c.label)}">
            `).join("")}
          </div>

          <div class="desc" style="margin-top:12px; color:#666;">
            (ì•½ ${Math.round(state.hwatu.memoryShownMs/1000)}ì´ˆ í›„ ë‹¤ìŒ ë‹¨ê³„ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.)
          </div>
        </div>
      `;

      setTimeout(()=>{
        renderHwatuRecall();
      }, state.hwatu.memoryShownMs);
    }

    /* =========================
      3) í™”íˆ¬: íšŒìƒ(ì•ë©´ 12ì¥ ëœë¤ ë°°ì¹˜) â†’ ë°©ê¸ˆ ë½‘ì€ 3ì¥ ë‹¤ì‹œ í´ë¦­
    ========================= */
    function renderHwatuRecall(){
      state.hwatu.recallStartAt = performance.now();
      state.hwatu.recallPicked = [];
      state.hwatu.recallCorrect = 0;

      const shuffledDeck = shuffle(deck);

      app.innerHTML = `
        <div class="card">
          <div class="title">ì•„ê¹Œ ë³¸ ì¹´ë“œ, ê¸°ì–µë‚˜ì‹œë‚˜ìš”?</div>
          <div class="desc">
            ì•„ë˜ ì¹´ë“œë“¤ ì¤‘ì—ì„œ<br>
            ì•„ê¹Œ ë³´ì•˜ë˜ ì¹´ë“œ <b>ì„¸ ì¥</b>ì„ ë‹¤ì‹œ í•œ ë²ˆ ê³¨ë¼ì£¼ì„¸ìš”.<br><br>
            ì™„ë²½í•˜ì§€ ì•Šì•„ë„ ê´œì°®ìŠµë‹ˆë‹¤.<br>
            ìƒê°í•´ë³´ëŠ” ê²ƒë§Œìœ¼ë¡œë„ ë¨¸ë¦¬ëŠ” ì´ë¯¸ ì¼ì„ í•˜ê³  ìˆìŠµë‹ˆë‹¤.
          </div>

          <div class="grid" id="recallGrid">
            ${shuffledDeck.map((c, idx)=>`
              <div class="flip-card picked-outline" style="outline:none; box-shadow:none; cursor:pointer;" data-idx="${idx}">
                <div class="face" style="position:relative; width:122px; height:188px; border-radius:14px; overflow:hidden; box-shadow:0 6px 18px rgba(0,0,0,0.12);">
                  <img src="${c.img}" alt="${escapeHtml(c.label)}">
                </div>
              </div>
            `).join("")}
          </div>

          <div class="desc" style="margin-top:10px; color:#666;">
            ì„ íƒ: <b><span id="recallCount">0</span>/3</b>
          </div>
        </div>
      `;

      const grid = document.getElementById("recallGrid");
      const recallCount = document.getElementById("recallCount");

      grid.querySelectorAll("[data-idx]").forEach(el=>{
        el.onclick = () => {
          const idx = Number(el.dataset.idx);
          const card = shuffledDeck[idx];

          if(state.hwatu.recallPicked.some(x=>x.id===card.id)) return;
          if(state.hwatu.recallPicked.length >= 3) return;

          state.hwatu.recallPicked.push(card);
          el.classList.add("picked-outline");
          recallCount.textContent = String(state.hwatu.recallPicked.length);

          if(state.hwatu.recallPicked.length === 3){
            // ì •í™•ë„ ê³„ì‚°
            const pickedIds = new Set(state.hwatu.picked.map(x=>x.id));
            state.hwatu.recallCorrect = state.hwatu.recallPicked.filter(x=>pickedIds.has(x.id)).length;

            // í´ë¦­ ì ê¸ˆ
            grid.querySelectorAll("[data-idx]").forEach(n=>n.style.pointerEvents="none");

            setTimeout(renderFortuneMessage, 600);
          }
        };
      });
    }

    /* =========================
      4) í–‰ìš´ ë©”ì‹œì§€ + ë‹¤ìŒ í™œë™ ê¶Œì¥ (íšŒìƒ ê²°ê³¼ì— ë”°ë¼)
    ========================= */
    function renderFortuneMessage(){
      const c = state.hwatu.recallCorrect;
      let msg = "";
      let title = "ì˜¤ëŠ˜ì˜ í–‰ìš´ ë©”ì‹œì§€";

      if(c === 3){
        title = "ğŸŒŸ ì˜¤ëŠ˜ ê¸°ì–µë ¥ì´ ì°¸ ë˜ë ·í–ˆì–´ìš”";
        msg = `
          ì•„ê¹Œ ë³´ì•˜ë˜ ì¹´ë“œë¥¼ <b>ì°¨ë¶„í•˜ê²Œ ì˜ ë– ì˜¬ë¦¬ì…¨ì–´ìš”</b>.<br>
          ì§‘ì¤‘í•˜ë©´ì„œ ìƒê°í•˜ì‹  ëª¨ìŠµì´ ì°¸ ì¢‹ì•˜ìŠµë‹ˆë‹¤.<br><br>
          ì´ëŸ° ì‹œê°„ë“¤ì´ ìŒ“ì´ë©´ ë¨¸ë¦¬ë„ ì ì  ë” ë˜ë ·í•´ì§‘ë‹ˆë‹¤.<br>
          ì´ì œ ë§ì„ ë– ì˜¬ë ¤ë³´ëŠ” í™œë™ìœ¼ë¡œ <b>ë¨¸ë¦¬ë¥¼ í•œ ë²ˆ ë” ê°€ë³ê²Œ</b> ì›€ì§ì—¬ë³¼ê¹Œìš”?
        `;
      }else if(c > 0){
        title = "ğŸŒ± ì²œì²œíˆ ì˜ í•´ë‚´ê³  ê³„ì„¸ìš”";
        msg = `
          ì¹´ë“œë¥¼ ë– ì˜¬ë¦¬ë ¤ê³  <b>ì²œì²œíˆ ìƒê°í•˜ì‹  ê²Œ ì°¸ ì¢‹ì•˜ì–´ìš”</b>.<br><br>
          ê¸°ì–µì€ ë°”ë¡œ ë– ì˜¤ë¥´ì§€ ì•Šì•„ë„ ê´œì°®ìŠµë‹ˆë‹¤.<br>
          ì´ë ‡ê²Œ í•œ ë²ˆì”© ìƒê°í•´ë³´ëŠ” ê²ƒë§Œìœ¼ë¡œë„ ë¨¸ë¦¬ëŠ” <b>ì¶©ë¶„íˆ ì¼ì„ í•˜ê³  ìˆì–´ìš”</b>.<br><br>
          ì´ì œ ë‹¨ì–´ë¥¼ ìƒê°í•´ë³´ëŠ” í™œë™ìœ¼ë¡œ ìì—°ìŠ¤ëŸ½ê²Œ ì´ì–´ê°€ë³¼ê²Œìš”.
        `;
      }else{
        title = "ğŸ˜Š ê´œì°®ì•„ìš”, ì§€ê¸ˆì´ ì—°ìŠµì´ì—ìš”";
        msg = `
          ê¸°ì–µì´ ë°”ë¡œ ë– ì˜¤ë¥´ì§€ ì•Šì•„ë„ <b>ì „í˜€ ê´œì°®ìŠµë‹ˆë‹¤</b>.<br><br>
          ë¨¸ë¦¬ëŠ” ì–µì§€ë¡œ ì“°ê¸°ë³´ë‹¤ëŠ” ì²œì²œíˆ ìì£¼ ì¨ì£¼ëŠ” ê²Œ ë” ì¢‹ì•„ìš”.<br>
          ì§€ê¸ˆì²˜ëŸ¼ í¸í•œ ë§ˆìŒìœ¼ë¡œ ì´ì–´ê°€ëŠ” ê²Œ ì¤‘ìš”í•©ë‹ˆë‹¤.<br><br>
          ì´ë²ˆì—ëŠ” ë‹¨ì–´ë¥¼ ê³¨ë¼ë³´ëŠ” í™œë™ì„ <b>ë¶€ë‹´ ì—†ì´</b> í•´ë³¼ê²Œìš”.
        `;
      }

      app.innerHTML = `
        <div class="card">
          <div class="title">${title}</div>
          <div class="desc">${msg}</div>
          <button class="btn" id="toWordBtn">ë‚±ë§ í™œë™ìœ¼ë¡œ ê°€ë³¼ê¹Œìš”?</button>
        </div>
      `;

      document.getElementById("toWordBtn").onclick = () => renderWordQuiz(0);
    }

    /* =========================
      5) ë‚±ë§ í€´ì¦ˆ (ë‹¨ì¼ì„ íƒ, 5ë¬¸í•­)
    ========================= */
    function renderWordQuiz(index){
      const total = wordQuizData.length;

      // ì™„ë£Œ ì‹œ ì¹˜ë§¤ì˜ˆë°© í€´ì¦ˆë¡œ
      if(index >= total){
        computeWordResults();
        renderDementiaQuiz(0);
        return;
      }

      const q = wordQuizData[index];
      const picked = state.word.answers[index];

      app.innerHTML = `
        <div class="card">
          <div class="pill">ë‚±ë§ í€´ì¦ˆ ${index+1} / ${total}</div>
          <div class="title">ë‹¨ì–´ë¥¼ í•œ ë²ˆ ìƒê°í•´ë³¼ê¹Œìš”?</div>
          <div class="desc">
            ë‹¨ì–´ ëœ»ì„ ë– ì˜¬ë¦¬ëŠ” ì‹œê°„ì…ë‹ˆë‹¤.<br>
            ì •ë‹µì„ ë§íˆë ¤ê³  ì• ì“°ì§€ ì•Šì•„ë„ ê´œì°®ì•„ìš”.<br>
            ê°€ì¥ ë§ëŠ” ê²ƒ ê°™ë‹¤ê³  ëŠê»´ì§€ëŠ” ê±¸ ê³¨ë¼ì£¼ì„¸ìš”.
          </div>
        </div>

        <div class="card">
          <div class="q-title">${escapeHtml(q.question)}</div>
          <div class="options" id="wordOpts">
            ${q.options.map((opt, i)=>`
              <div class="option ${picked===i ? "selected":""}" data-i="${i}">
                ${escapeHtml(opt)}
              </div>
            `).join("")}
          </div>

          <button class="btn" id="wordNextBtn" ${picked===null ? "disabled":""}>
            ${index === total-1 ? "ë‹¤ìŒ(ì¹˜ë§¤ ì˜ˆë°© í€´ì¦ˆë¡œ)" : "ë‹¤ìŒ"}
          </button>
        </div>
      `;

      const opts = document.getElementById("wordOpts");
      const btn = document.getElementById("wordNextBtn");

      opts.querySelectorAll(".option").forEach(el=>{
        el.onclick = () => {
          const i = Number(el.dataset.i);
          state.word.answers[index] = i;
          opts.querySelectorAll(".option").forEach(x=>x.classList.remove("selected"));
          el.classList.add("selected");
          btn.disabled = false;
        };
      });

      btn.onclick = () => renderWordQuiz(index+1);
    }

    function computeWordResults(){
      const results = [];
      let score = 0;

      wordQuizData.forEach((q, idx)=>{
        const ua = state.word.answers[idx];
        const isCorrect = ua === q.correct;
        if(isCorrect) score++;

        results.push({
          question: q.question,
          options: q.options,
          userAnswerIndex: ua,
          userAnswer: ua !== null ? q.options[ua] : "(ë¯¸ì‘ë‹µ)",
          correctIndex: q.correct,
          correctAnswer: q.options[q.correct],
          isCorrect,
          explanation: q.explanation
        });
      });

      state.word.results = results;
      state.word.score = score;
    }

    /* =========================
      6) ì¹˜ë§¤ ì˜ˆë°© í€´ì¦ˆ (ë‹¨ì¼ì„ íƒ, 5ë¬¸í•­) + ëë‚˜ë©´ ê²°ê³¼/í•´ì„¤ í‘œì‹œ
    ========================= */
    function renderDementiaQuiz(index){
      const total = dementiaQuizData.length;

      if(index >= total){
        computeDementiaResults();
        renderDementiaReview();
        return;
      }

      const q = dementiaQuizData[index];
      const picked = state.dementia.answers[index];

      app.innerHTML = `
        <div class="card">
          <div class="pill">ì¹˜ë§¤ ì˜ˆë°© í€´ì¦ˆ ${index+1} / ${total}</div>
          <div class="title">ë¨¸ë¦¬ì— ì¢‹ì€ ì´ì•¼ê¸° í•œ ë²ˆ ì‚´í´ë³¼ê¹Œìš”?</div>
          <div class="desc">
            ì§€ê¸ˆë¶€í„°ëŠ” ë¨¸ë¦¬ë¥¼ ê±´ê°•í•˜ê²Œ ì“°ëŠ” ë° ë„ì›€ì´ ë˜ëŠ” ìƒí™œ ì´ì•¼ê¸°ì…ë‹ˆë‹¤.<br>
            ëª¨ë‘ ë§íˆë ¤ê³  í•˜ì§€ ì•Šì•„ë„ ê´œì°®ì•„ìš”.<br>
            ê°€ì¥ ë§ëŠ” ê²ƒ ê°™ë‹¤ê³  ëŠê»´ì§€ëŠ” ê±¸ ê³¨ë¼ì£¼ì„¸ìš”.
          </div>
        </div>

        <div class="card">
          <div class="q-title">${escapeHtml(q.question)}</div>
          <div class="options" id="demOpts">
            ${q.options.map((opt, i)=>`
              <div class="option ${picked===i ? "selected":""}" data-i="${i}">
                ${escapeHtml(opt)}
              </div>
            `).join("")}
          </div>

          <button class="btn" id="demNextBtn" ${picked===null ? "disabled":""}>
            ${index === total-1 ? "ì œì¶œí•˜ê³  í•´ì„¤ ë³´ê¸°" : "ë‹¤ìŒ"}
          </button>
        </div>
      `;

      const opts = document.getElementById("demOpts");
      const btn = document.getElementById("demNextBtn");

      opts.querySelectorAll(".option").forEach(el=>{
        el.onclick = () => {
          const i = Number(el.dataset.i);
          state.dementia.answers[index] = i;
          opts.querySelectorAll(".option").forEach(x=>x.classList.remove("selected"));
          el.classList.add("selected");
          btn.disabled = false;
        };
      });

      btn.onclick = () => renderDementiaQuiz(index+1);
    }

    function computeDementiaResults(){
      const results = [];
      let score = 0;

      dementiaQuizData.forEach((q, idx)=>{
        const ua = state.dementia.answers[idx];
        const isCorrect = ua === q.correct;
        if(isCorrect) score++;

        results.push({
          question: q.question,
          options: q.options,
          userAnswerIndex: ua,
          userAnswer: ua !== null ? q.options[ua] : "(ë¯¸ì‘ë‹µ)",
          correctIndex: q.correct,
          correctAnswer: q.options[q.correct],
          isCorrect,
          explanation: q.explanation
        });
      });

      state.dementia.results = results;
      state.dementia.score = score;
    }

    function renderDementiaReview(){
      app.innerHTML = `
        <div class="card">
          <div class="title">í•´ì„¤ì„ í•¨ê»˜ ë³¼ê¹Œìš”?</div>
          <div class="desc">
            ì •ë‹µì„ ë§íˆëŠ” ê²ƒë„ ì¢‹ì§€ë§Œ,<br>
            <b>í•´ì„¤ì„ ì½ì–´ë³´ëŠ” ê²ƒ</b> ìì²´ê°€ ë‘ë‡Œ í™œë™ì´ ë©ë‹ˆë‹¤.
          </div>
        </div>

        ${state.dementia.results.map((r, idx)=>`
          <div class="card" id="r-${idx}">
            <div class="pill">ë¬¸ì œ ${idx+1}</div>
            <div class="q-title">${escapeHtml(r.question)}</div>
            <div class="options">
              ${r.options.map((opt, i)=>{
                const cls =
                  (i === r.userAnswerIndex && i === r.correctIndex) ? "option correct" :
                  (i === r.userAnswerIndex && i !== r.correctIndex) ? "option wrong" :
                  (i === r.correctIndex) ? "option correct" : "option";
                return `<div class="${cls}">${escapeHtml(opt)}</div>`;
              }).join("")}
            </div>
            <div class="desc" style="margin-top:10px;">
              <b>ë‚´ê°€ ê³ ë¥¸ ë‹µ:</b> ${escapeHtml(r.userAnswer)}<br>
              <b>ì •ë‹µ:</b> ${escapeHtml(r.correctAnswer)}<br><br>
              <b>í•´ì„¤:</b> ${escapeHtml(r.explanation)}
            </div>
          </div>
        `).join("")}

        <div class="card">
          <div class="title">ì´ì œ ê²°ê³¼ë¥¼ ì €ì¥í• ê¹Œìš”?</div>
          <div class="desc">
            ì˜¤ëŠ˜ í•˜ì‹  ë‚´ìš©ì´ ê¸°ë¡ìœ¼ë¡œ ë‚¨ì•„ì•¼,<br>
            ë‹¤ìŒì— ë‹¤ì‹œ í–ˆì„ ë•Œ ë³€í™”ë„ ë¹„êµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          </div>
          <button class="btn" id="saveBtn">ê²°ê³¼ ì €ì¥í•˜ê¸°</button>
          <div class="status" id="statusBox"></div>
        </div>
      `;

      document.getElementById("saveBtn").onclick = saveAll;
    }

    /* =========================
      7) ì €ì¥: ëª¨ë“  ê²°ê³¼ë¥¼ í•œ ë²ˆì— ì „ì†¡ â†’ Netlify Functionì´ ë¬¸ì„œ ìƒì„±/ì—…ë¡œë“œ/D-ID ë“±ë¡
    ========================= */
    async function saveAll(){
      const btn = document.getElementById("saveBtn");
      const status = document.getElementById("statusBox");

      btn.disabled = true;
      btn.textContent = "â³ ì €ì¥ ì¤‘...";

      state.endISO = nowISO();

      // ì‹œê°„ ê³„ì‚°(ì°¸ê³ ìš©)
      const memoryElapsedMs = Math.max(0, Math.round(performance.now() - state.hwatu.memoryStartAt));
      const recallElapsedMs  = Math.max(0, Math.round(performance.now() - state.hwatu.recallStartAt));

      const payload = {
        userName: state.userName,
        sessionId: state.sessionId,
        startedAt: state.startISO,
        endedAt: state.endISO,

        hwatu: {
          deckOrder: state.hwatu.deckOrder,
          picked: state.hwatu.picked.map(c=>({ id:c.id, key:c.key, label:c.label })),
          recallPicked: state.hwatu.recallPicked.map(c=>({ id:c.id, key:c.key, label:c.label })),
          recallCorrect: state.hwatu.recallCorrect,
          recallTotal: 3,
          memoryShownMs: state.hwatu.memoryShownMs,
          memoryElapsedMs,
          recallElapsedMs
        },

        word: {
          score: state.word.score,
          total: wordQuizData.length,
          results: state.word.results
        },

        dementia: {
          score: state.dementia.score,
          total: dementiaQuizData.length,
          results: state.dementia.results
        }
      };

      try{
        const res = await fetch("/.netlify/functions/save-answer", {
          method:"POST",
          headers:{ "Content-Type":"application/json" },
          body: JSON.stringify(payload)
        });

        const text = await res.text();
        let data = {};
        try{ data = JSON.parse(text); } catch(e){ data = { raw:text }; }

        if(!res.ok){
          status.className = "status show error";
          status.innerHTML = `âš ï¸ ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br><br>${escapeHtml(data.detail || data.error || data.raw || "ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜")}`;
          btn.disabled = false;
          btn.textContent = "ê²°ê³¼ ì €ì¥í•˜ê¸°";
          return;
        }

        status.className = "status show success";
        status.innerHTML = `âœ… ${escapeHtml(state.userName)}ë‹˜, ì˜¤ëŠ˜ ê²°ê³¼ê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.<br>
          ë‹¤ìŒì— ë‹¤ì‹œ í•´ë³´ì‹œë©´ ë³€í™”ë„ í•¨ê»˜ ë³¼ ìˆ˜ ìˆì–´ìš”.<br><br>
          ${data.githubUrl ? `ê¸°ë¡ íŒŒì¼: ${escapeHtml(data.githubUrl)}` : ""}`;

        btn.textContent = "âœ… ì €ì¥ ì™„ë£Œ";

        // ì €ì¥ ì™„ë£Œ í™”ë©´ + ë‹¤ì‹œí•˜ê¸°
        setTimeout(()=>renderDone(data.githubUrl), 900);

      }catch(err){
        status.className = "status show error";
        status.innerHTML = `âš ï¸ ì €ì¥ ìš”ì²­ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.<br><br>${escapeHtml(err.message)}`;
        btn.disabled = false;
        btn.textContent = "ê²°ê³¼ ì €ì¥í•˜ê¸°";
      }
    }

    function renderDone(githubUrl){
      app.innerHTML = `
        <div class="card">
          <div class="title">ì˜¤ëŠ˜ë„ ìˆ˜ê³  ë§ìœ¼ì…¨ì–´ìš”</div>
          <div class="desc">
            ì˜¤ëŠ˜ í•˜ì‹  ë‘ë‡Œ í™œë™ì´ <b>ê¸°ë¡ìœ¼ë¡œ ì €ì¥</b>ë˜ì—ˆìŠµë‹ˆë‹¤.<br><br>
            ì´ëŸ° í™œë™ì€ í•˜ë£¨ì— í•œ ë²ˆì´ë©´ ì¶©ë¶„í•©ë‹ˆë‹¤.<br>
            ë‚´ì¼ ë˜ ìƒê°ë‚˜ë©´ í•œ ë²ˆ ë” í•´ë³´ì…”ë„ ì¢‹ì•„ìš”.<br><br>
            ${githubUrl ? `<span style="color:#666;">(ì €ì¥ íŒŒì¼: ${escapeHtml(githubUrl)})</span>` : ""}
          </div>
          <button class="btn" id="restartBtn">ì²˜ìŒ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ê¸°</button>
        </div>
      `;
      document.getElementById("restartBtn").onclick = () => {
        // í”„ë¡œí† íƒ€ì… ë°˜ë³µ í…ŒìŠ¤íŠ¸/ë¹„êµë¥¼ ìœ„í•´ ìƒˆ ì„¸ì…˜ ì‹œì‘
        renderIntro();
      };
    }

    // ì‹œì‘
    renderIntro();
  </script>
</body>
</html>
